{% extends 'layout.html.twig' %}

{% block title %}
    Patient
    {{ patient.nom }}
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/index.css') }}">
{% endblock %}

{% form_theme form _self %}

{% block form_label %}
    {% if label is not same as(false) %}
        {% if not compound %}
            {% set label_attr = label_attr|merge({'for': id}) %}
        {% endif %}
        {% if required %}
            {% set label_attr = label_attr|merge({'class': (label_attr.class|default('') ~ ' required')|trim}) %}
        {% endif %}
        {% if label is empty %}
            {% if label_format is not empty %}
                {% set label = label_format|replace({
                    '%name%': name,
                    '%id%': id,
                }) %}
            {% else %}
                {% set label = name|humanize %}
            {% endif %}
        {% endif %}
        <{{ element|default('label') }}{% if label_attr %}{% with { attr: label_attr } %}{{ block('attributes') }}{% endwith %}{% endif %}>
            <span></span>
            {{ label }}
        </{{ element|default('label') }}>
    {% endif %}
{% endblock form_label %}

{% block choice_widget_expanded %}
    <div {{ block('widget_container_attributes') }}>
        {% for child in form %}
            <div class="radio-container">
                {{ form_widget(child) }}
                {{ form_label(child, null, {translation_domain: choice_translation_domain}) }}
            </div>
        {% endfor %}
    </div>
{% endblock choice_widget_expanded %}

{% block _qcm_question_widget -%}
    <div class="wrap-input">
        {% if compound %}
            {{ block('form_widget_compound') }}
        {% else %}
            {{ block('form_widget_simple') }}
        {% endif %}
        <span class="focus-input"></span>
    </div>
{% endblock _qcm_question_widget %}

{% block form_row %}
    {% set widget_attr = {} %}
    {% if help is not empty %}
        {% set widget_attr = {attr: {'aria-describedby': id ~"_help"}} %}
    {% endif %}
    <div class="wrap-input" {% with {attr: row_attr|default({} )} %} {{ block('attributes') }} {% endwith %}>
        {{ form_label(form) }}
        {{ form_errors(form) }}
        {{ form_widget(form, widget_attr) }}
        {{ form_help(form) }}
        <span class="focus-input"></span>
    </div>
{% endblock form_row %}

{% block page_content %}

    <div class="container-form">
        <!-- Hero -->
        <section class="hero-tabs">
            <div class="hero-header">
                <div id="title" class="hero-title">
                    <h1 class="hero-center">
                        Etude de la réserve coronaire en scintigraphie
                        <br>chez le patient diabétique
                    </h1>
                </div>
                <div class="hero-title">
                    <h3 class="intro">PATIENT&nbsp;
                        <span>{{ patient.nom }}&nbsp;{{ patient.prenom }}</span>
                    </h3>
                </div>

                <div class="button-block">
                    <a href="{{ path('index_patient') }}" class="form-btn btn-default">
                        <i aria-hidden="true" class="fa fa-arrow-left"></i>Retour</a>
                    {% if is_granted('ROLE_SUPER_ADMIN') %}
                    <button class="form-btn" data-target="#save-modal" data-toggle="modal" type="button">
                        <i aria-hidden="true" class="fa fa-check"></i>Valider le patient</button>
                    {% endif %}
                    {{ include('patient/_delete_form.html.twig') }}
                </div>
            </div>

            <div class="hero-tabs-container">
                <a class="hero-tab" href="#tab-generales">Données générales</a>
                <a class="hero-tab" href="#tab-cardiovasculaires">Données cardiovasculaires</a>
                <a class="hero-tab" href="#tab-paracliniques">Examens paracliniques</a>
                <a class="hero-tab" href="#tab-suivi">Suivi</a>
                <span class="hero-tab-slider"></span>
            </div>
        </section>


        <!-- Toc -->
        <nav class="toc">
            <ul>
                <li><a href="#title">Patient {{ patient.nom }}</a></li>
                <li>
                    <a href="#informations">Informations générales</a>
                </li>
                <li>
                    <a href="#cardiovasculaires">Données cardiovasculaires</a>
                    <ul>
                        <li><a href="#risque">Facteurs de risque cardiovasculaire</a></li>
                        <li><a href="#antecedents">Antécédents cardiovasculaires personnels</a></li>
                        <li><a href="#precisions">Précision concernant un éventuel antécédent(s) d'infarctus</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#paracliniques">Examens paracliniques</a>
                    <ul>
                        <li><a href="#biologie">Biologie</a></li>
                        <li><a href="#doppler">Ultrasons doppler</a></li>
                        <li><a href="#examens">Examens sensoriels</a></li>
                        <li><a href="#scintigraphie">Scintigraphie</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#evenement">Données à 6 mois de l'événement</a>
                    <ul>
                        <li><a href="#recidive">Récidive</a></li>
                        <li><a href="#clinique">Clinique</a></li>
                        <li><a href="#facteur">Facteurs de risque cardiovasculaire</a></li>
                        <li><a href="#place">Traitement mis en place suite à l'évènement cardiovasculaire</a></li>
                        <li><a href="#biologie2">Biologie</a></li>
                        <li><a href="#hematopoiese">Hématopoïèse Clonale</a></li>
                        <li><a href="#evaluation">Evaluation cardiovasculaire</a></li>
                    </ul>
                </li>
            </ul>
            <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
            </svg>
        </nav>

        <!-- Main -->
        <main class="main">
            {{ form_start(form, {'attr': {'class': 'form validate-form', 'autocomplete' : 'off'} }) }}
            {{ form_errors(form) }}

            <section class="slide" id="tab-generales">
                <h1 id="informations">Informations générales</h1>
                <div class="form-space">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.nom, {'attr': {'autofocus' : true, 'class': 'input', 'autocomplete' : 'off'} }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.prenom, {'attr': {'class': 'input', 'autocomplete' : 'off'} }) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.sexe, {'attr': {'class': 'input radio-row', 'autocomplete' : 'off'} }) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.dateNaissance, {'attr': {'class': 'input', 'autocomplete' : 'off'} }) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.age, {'attr': {'class': 'input', 'autocomplete' : 'off'} }) }}
                        </div>
                    </div>
                </div>
            </section>

            <section class="slide" id="tab-cardiovasculaires">
                <h1 id="cardiovasculaires">Données cardiovasculaires</h1>

                <h3 id="risque">Facteurs de risque cardiovasculaire</h3>
                <div class="form-space">
                    <div class="margin-space"></div>
                    <h5>HTA</h5>

                    <div class="margin-space"></div>
                    <h5>Tabagisme</h5>

                    <div class="margin-space"></div>
                    <h5>Alcool</h5>

                    <div class="margin-space"></div>
                    <h5>Données anthropométriques</h5>

                    <div class="margin-space"></div>
                    <h5>Diabète</h5>
                </div>

                <h3 id="antecedents">Antécédents cardiovasculaires personnels</h3>
                <div class="qcm">
                    {% for pack in form.cardiovasculaire.antecedents.qcm %}
                        <div class="qcm-row">
                            <div class="qcm-question">
                                {{ form_widget(pack.question, {'attr': {'class': 'input'} }) }}
                            </div>
                            <div class="qcm-response">
                                <div class="wrap-input">
                                    {{ form_widget(pack.reponse, {'attr': {'class': 'input radio-row'} }) }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <h3 id="precisions">Précision concernant un éventuel antécédent(s) d'infarctus</h3>
                <div class="qcm">
                    {% for qcm in form.cardiovasculaire.precisions.qcm %}
                        {% set counter = ( counter | default(0) ) + 1 %}
                        {% if counter == 1 %}
                            <div class="margin-space"></div>
                            <h5>Infarctus du myocarde</h5>
                        {% elseif counter == 2 %}
                            <div class="margin-space"></div>
                            <h5>Territoire</h5>
                        {% endif %}

                        <div class="qcm-row">
                            <div class="qcm-question">
                                {{ form_widget(qcm.question, {'attr': {'class': 'input'} }) }}
                            </div>
                            <div class="qcm-response">
                                <div class="wrap-input">
                                    {{ form_widget(qcm.reponse, {'attr': {'class': 'input radio-row'} }) }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </section>

            <section class="slide" id="tab-paracliniques">
                <h1 id="paracliniques">Examens paracliniques</h1>

                <h3 id="biologie">Biologie</h3>
                <div class="form-space">
                </div>

                <h3 id="doppler">Ultrasons doppler</h3>
                <h5>Données hémodynamiques doppler</h5>

                {# <div class="margin-space"></div> #}

                <h3 id="examens">Examens sensoriels</h3>
                <div class="form-space"></div>

                <h3 id="scintigraphie">Scintigraphie</h3>

                <div class="separator-space"></div>
                <h5>Débits</h5>

                <div class="separator-space"></div>
                <h5>Analyse visuelle perfusion de repos</h5>

                <div class="separator-space"></div>
                <h5>Coronarographie (sténose >50%)</h5>
                {# TODO: bulle info -> "ne remplir que si coronarographie de moins de 1 an" #}

                <div class="separator-space"></div>
                <h5>Traitement</h5>
                {# TODO: bulle info -> "disponible sur compte-rendu scintigraphie" #}

            </section>

            <section class="slide" id="tab-suivi">
                <h1 id="suivi">Suivi</h1>

                <h3 id="evenement">Evénement(s) clinique(s)/biologique(s) indésirable(s) survenu(s) depuis l’inclusion</h3>
            </section>

            {{ form_row(form._token) }}
            {{ form_end(form, {'render_rest' : false}) }}

        </main>

        <div class="cd-top cd-top--fade-out js-cd-top">
            <a href="{{ path('index_patient') }}" class="cd-btn btn-back">
                <i aria-hidden="true" class="fa fa-arrow-left"></i>
            </a>
            <a class="cd-btn btn-check" data-target="#save-modal" data-toggle="modal">
                <i aria-hidden="true" class="fa fa-check"></i>
            </a>
            <a class="cd-btn btn-delete">
                <i aria-hidden="true" class="fa fa-trash"></i>
            </a>
            <a class="cd-btn btn-top" href="#0">
                <i aria-hidden="true" class="fa fa-chevron-up"></i>
            </a>
        </div>

    </div>

{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/toc.js') }}"></script>
    <script>
        $('ul li').on('click', function () {
            $('li').removeClass('active');
            $(this).addClass('active');
        });
    </script>

    <script>
        /* Smooth scroll */
        $('.toc a').on('click', function () {
            var page = $(this).attr('href');
            var speed = 550;
            $('html, body').animate({ scrollTop: $(page).offset().top - 90 }, speed);
            return false;
        });
    </script>
    <script>
        class StickyNavigation {

            constructor() {
                this.currentId = null;
                this.currentTab = null;
                this.tabContainerHeight = 70;
                this.navbar = 80;
                let self = this;
                $('.hero-tab').click(function () {
                    self.onTabClick(event, $(this));
                });
                $(window).scroll(() => {
                    this.onScroll();
                });
                $(window).resize(() => {
                    this.onResize();
                });
            }

            onTabClick(event, element) {
                event.preventDefault();
                let scrollTop = $(element.attr('href')).offset().top - this.tabContainerHeight + 1;
                $('html, body').animate({
                    scrollTop: scrollTop
                }, 600);
            }

            onScroll() {
                this.checkTabContainerPosition();
                this.findCurrentTabSelector();
            }

            onResize() {
                if (this.currentId) {
                    this.setSliderCss();
                }
            }

            checkTabContainerPosition() {
                let offset = $('.hero-tabs').offset().top + $('.hero-tabs').height() - this.tabContainerHeight;
                if ($(window).scrollTop() > offset) {
                    $('.hero-tabs-container').addClass('hero-tabs-container--top');
                    $('.toc').addClass('toc--top');
                }
                else {
                    $('.hero-tabs-container').removeClass('hero-tabs-container--top');
                    $('.toc').removeClass('toc--top');
                }
            }

            findCurrentTabSelector(element) {
                let newCurrentId;
                let newCurrentTab;
                let self = this;
                $('.hero-tab').each(function () {
                    let id = $(this).attr('href');
                    let offsetTop = $(id).offset().top - self.tabContainerHeight;
                    let offsetBottom = $(id).offset().top + $(id).height() - self.tabContainerHeight;
                    if ($(window).scrollTop() > offsetTop && $(window).scrollTop() < offsetBottom) {
                        newCurrentId = id;
                        newCurrentTab = $(this);
                    }
                });
                if (this.currentId != newCurrentId || this.currentId === null) {
                    this.currentId = newCurrentId;
                    this.currentTab = newCurrentTab;
                    this.setSliderCss();
                }
            }

            setSliderCss() {
                let width = 0;
                let left = 0;
                if (this.currentTab) {
                    width = this.currentTab.css('width');
                    left = this.currentTab.offset().left - this.navbar;
                }
                $('.hero-tab-slider').css('width', width);
                $('.hero-tab-slider').css('left', left);
            }

        }

        new StickyNavigation();
    </script>
{% endblock %}
